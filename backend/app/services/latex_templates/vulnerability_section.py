# backend/app/services/latex_templates/vulnerability_section.py

from pylatex import Section, Subsection, NoEscape
from pylatex.utils import escape_latex
import re

def generate_vulnerability_sections(doc, data):
    """
    Generates comprehensive Detailed Findings section with enhanced formatting,
    grouping by severity, and rich metadata display.
    """
    
    with doc.create(Section("Detailed Vulnerability Findings")):
        
        vulnerabilities = data['vulnerabilities']
        
        if not vulnerabilities:
            doc.append(NoEscape(r'''
            \begin{tcolorbox}[colback=success!10, colframe=success, title=\textbf{Clean Security Scan}]
                \textbf{Congratulations! } No vulnerabilities were detected in this security assessment.  
                
                \vspace{0.2cm}
                \textbf{Recommendations for Maintaining Security: }
                \begin{itemize}[leftmargin=*, topsep=3pt, itemsep=3pt]
                    \item Continue regular security scanning (weekly/bi-weekly recommended)
                    \item Keep all dependencies updated to latest stable versions
                    \item Implement security training for development team
                    \item Enable automated security checks in CI/CD pipeline
                    \item Conduct periodic penetration testing
                \end{itemize}
            \end{tcolorbox}
            '''))
            return
        
        # =====================================================================
        # INTRODUCTION & READING GUIDE
        # =====================================================================
        
        doc.append(NoEscape(r'''
        \noindent
        This section provides comprehensive technical details for each identified vulnerability, 
        including code snippets, remediation guidance, and compliance mappings.  Findings are 
        organized by severity level for prioritized remediation.
        
        \vspace{0.3cm}
        \textbf{Reading Guide:}
        \begin{itemize}[leftmargin=*, topsep=3pt, itemsep=3pt]
            \item \textbf{CWE/OWASP: } Industry-standard vulnerability classifications
            \item \textbf{CVSS Score:} Risk rating from 0.0 (low) to 10.0 (critical)
            \item \textbf{Location:} Exact file path and line number(s)
            \item \textbf{Code Snippet:} Vulnerable code section
            \item \textbf{Remediation:} Step-by-step fix guidance
            \item \textbf{Fix Suggestion:} Automated or recommended code changes
        \end{itemize}
        '''))
        
        doc.append(NoEscape(r'\vspace{0.5cm}'))
        
        # =====================================================================
        # GROUP VULNERABILITIES BY SEVERITY
        # =====================================================================
        
        critical_vulns = [v for v in vulnerabilities if v['severity'] == 'critical']
        high_vulns = [v for v in vulnerabilities if v['severity'] == 'high']
        medium_vulns = [v for v in vulnerabilities if v['severity'] == 'medium']
        low_vulns = [v for v in vulnerabilities if v['severity'] == 'low']
        info_vulns = [v for v in vulnerabilities if v['severity'] == 'info']
        
        # =====================================================================
        # CRITICAL SEVERITY SECTION
        # =====================================================================
        
        if critical_vulns:
            with doc.create(Subsection(f'Critical Severity Issues ({len(critical_vulns)} found)')):
                
                doc.append(NoEscape(r'''
                \begin{tcolorbox}[colback=SevCritical!10, colframe=SevCritical, boxrule=2pt]
                    \textbf{\textcolor{SevCritical}{IMMEDIATE ACTION REQUIRED}}
                    
                    \vspace{0.2cm}
                    Critical vulnerabilities represent \textbf{immediate threats} that could lead to: 
                    \begin{itemize}[leftmargin=*, topsep=2pt, itemsep=2pt]
                        \item Complete system compromise
                        \item Unauthorized data access or exfiltration  
                        \item Remote code execution
                        \item Privilege escalation to administrator level
                    \end{itemize}
                    
                    \textbf{Recommended Timeline:} Fix within \textbf{24-72 hours}
                \end{tcolorbox}
                \vspace{0.3cm}
                '''))
                
                for vuln in critical_vulns: 
                    _render_vulnerability_finding(doc, vuln, 'SevCritical')
        
        # =====================================================================
        # HIGH SEVERITY SECTION
        # =====================================================================
        
        if high_vulns:
            doc.append(NoEscape(r'\newpage'))
            
            with doc.create(Subsection(f'High Severity Issues ({len(high_vulns)} found)')):
                
                doc.append(NoEscape(r'''
                \begin{tcolorbox}[colback=SevHigh!10, colframe=SevHigh, boxrule=2pt]
                    \textbf{\textcolor{SevHigh}{URGENT ATTENTION NEEDED}}
                    
                    \vspace{0.2cm}
                    High severity vulnerabilities pose \textbf{significant security risks} including:
                    \begin{itemize}[leftmargin=*, topsep=2pt, itemsep=2pt]
                        \item Sensitive data exposure
                        \item Authentication bypass
                        \item Unauthorized access to protected resources
                        \item Injection attacks (SQL, XSS, Command)
                    \end{itemize}
                    
                    \textbf{Recommended Timeline:} Fix within \textbf{7-14 days}
                \end{tcolorbox}
                \vspace{0.3cm}
                '''))
                
                for vuln in high_vulns:
                    _render_vulnerability_finding(doc, vuln, 'SevHigh')
        
        # =====================================================================
        # MEDIUM SEVERITY SECTION
        # =====================================================================
        
        if medium_vulns:
            doc.append(NoEscape(r'\newpage'))
            
            with doc.create(Subsection(f'Medium Severity Issues ({len(medium_vulns)} found)')):
                
                doc.append(NoEscape(r'''
                \begin{tcolorbox}[colback=SevMedium!10, colframe=SevMedium, boxrule=1.5pt]
                    \textbf{\textcolor{SevMedium}{Address in Next Sprint}}
                    
                    \vspace{0.2cm}
                    Medium severity issues represent \textbf{moderate security risks} that should be 
                    addressed but may not pose immediate threats.  Include these in upcoming development cycles.
                    
                    \textbf{Recommended Timeline: } Fix within \textbf{30-60 days}
                \end{tcolorbox}
                \vspace{0.3cm}
                '''))
                
                # For medium, show first 15, then summary
                for vuln in medium_vulns[:15]:
                    _render_vulnerability_finding(doc, vuln, 'SevMedium')
                
                if len(medium_vulns) > 15:
                    remaining = len(medium_vulns) - 15
                    doc.append(NoEscape(rf'''
                    \vspace{{0.3cm}}
                    \begin{{tcolorbox}}[colback=SevMedium!5, colframe=SevMedium]
                        \textbf{{Additional Medium Severity Findings:}} {remaining} more medium severity 
                        issues are documented in the full scan results.  Access the complete report via 
                        the SecureThread OPS dashboard for detailed remediation guidance.
                    \end{{tcolorbox}}
                    '''))
        
        # =====================================================================
        # LOW SEVERITY SECTION (SUMMARY ONLY)
        # =====================================================================
        
        if low_vulns:
            doc.append(NoEscape(r'\newpage'))
            
            with doc.create(Subsection(f'Low Severity Issues ({len(low_vulns)} found)')):
                
                doc.append(NoEscape(r'''
                \begin{tcolorbox}[colback=SevLow!10, colframe=SevLow, boxrule=1pt]
                    \textbf{\textcolor{SevLow}{Maintenance Priority}}
                    
                    \vspace{0.2cm}
                    Low severity issues have \textbf{minimal immediate risk} but should be addressed 
                    during regular maintenance to improve overall code quality and security posture.
                    
                    \textbf{Recommended Timeline:} Fix during \textbf{regular maintenance cycles}
                \end{tcolorbox}
                \vspace{0.3cm}
                '''))
                
                # For low severity, show summary table instead of full details
                _render_low_severity_summary(doc, low_vulns)
        
        # =====================================================================
        # INFORMATIONAL FINDINGS (IF ANY)
        # =====================================================================
        
        if info_vulns:
            with doc.create(Subsection(f'Informational Findings ({len(info_vulns)} found)')):
                
                doc.append(NoEscape(r'''
                \noindent
                \textit{Informational findings are security best practice recommendations without 
                direct exploitability. Consider implementing these suggestions to enhance security posture.}
                \vspace{0.3cm}
                '''))
                
                _render_informational_summary(doc, info_vulns)


def _render_vulnerability_finding(doc, vuln, color_name):
    """
    Render a single comprehensive vulnerability finding box
    """
    
    # Determine confidence badge
    confidence = vuln.get('confidence', 'medium')
    if confidence == 'high':
        confidence_badge = r'\textcolor{success}{\textbf{HIGH}}'
    elif confidence == 'medium': 
        confidence_badge = r'\textcolor{SevMedium}{\textbf{MEDIUM}}'
    else:
        confidence_badge = r'\textcolor{gray}{\textbf{LOW}}'
    
    # Build title with ID
    title = f"\\#{vuln['index']}: {vuln['title']}"
    
    doc.append(NoEscape(rf'''
    \begin{{findingbox}}[{title}]{{{color_name}}}
    '''))
    
    # -------------------------------------------------------------------------
    # METADATA SECTION
    # -------------------------------------------------------------------------
    
    doc.append(NoEscape(r'''
    \begin{tcolorbox}[colback=white, colframe=STBgGray, boxrule=0.5pt, left=3pt, right=3pt, top=3pt, bottom=3pt]
        \small
        \renewcommand{\arraystretch}{1.3}
        \begin{tabular}{@{}p{0.18\textwidth} p{0.78\textwidth}@{}}
    '''))
    
    # Row 1: Severity and CWE
    doc.append(NoEscape(rf'''
        \textbf{{Severity: }} & \textcolor{{{color_name}}}{{\textbf{{{vuln['severity'].upper()}}}}} 
        (CVSS: \textbf{{{vuln['cvss']:.1f}/10.0}}) \\
    '''))
    
    # Row 2: CWE and OWASP
    doc.append(NoEscape(rf'''
        \textbf{{CWE ID:}} & {vuln['cwe']} \hspace{{1cm}} 
        \textbf{{OWASP: }} {vuln['owasp']} \\
    '''))
    
    # Row 3: Category and Confidence
    doc.append(NoEscape(rf'''
        \textbf{{Category:}} & {vuln['category']} \hspace{{1cm}} 
        \textbf{{Confidence:}} {confidence_badge} \\
    '''))
    
    # Row 4: Location
    location_display = vuln['location']
    if len(location_display) > 80:
        location_display = location_display[:77] + "..."
    
    doc.append(NoEscape(rf'''
        \textbf{{Location:}} & \texttt{{\footnotesize {location_display}}} \\
    '''))
    
    # Row 5: Line Range
    doc.append(NoEscape(rf'''
        \textbf{{Line(s):}} & {vuln['line_range']} \\
    '''))
    
    # Row 6: Exploitability and Impact
    if vuln.get('exploitability') or vuln.get('impact'):
        exp = vuln.get('exploitability', 'Unknown')
        imp = vuln.get('impact', 'Unknown')
        
        exp_color = 'SevCritical' if exp.lower() == 'easy' else 'SevMedium' if exp.lower() == 'medium' else 'SevLow'
        
        doc.append(NoEscape(rf'''
            \textbf{{Exploitability:}} & \textcolor{{{exp_color}}}{{\textbf{{{exp}}}}} \hspace{{1cm}} 
            \textbf{{Impact: }} {imp} \\
        '''))
    
    doc.append(NoEscape(r'''
        \end{tabular}
    \end{tcolorbox}
    '''))
    
    doc.append(NoEscape(r'\vspace{0.3cm}'))
    
    # -------------------------------------------------------------------------
    # DESCRIPTION SECTION
    # -------------------------------------------------------------------------
    
    doc.append(NoEscape(r'\textbf{\large Description}\\[0.2cm]'))
    doc.append(NoEscape(vuln['description']))
    
    doc.append(NoEscape(r'\vspace{0.3cm}'))
    
    # -------------------------------------------------------------------------
    # VULNERABLE CODE SECTION
    # -------------------------------------------------------------------------
    
    if vuln.get('code_snippet'):
        doc.append(NoEscape(r'\textbf{\large Vulnerable Code}\\[0.2cm]'))
        
        raw_code = vuln['code_snippet']. strip()
        
        # Truncate if too long (prevent page overflow)
        if len(raw_code) > 1200:
            raw_code = raw_code[:1200] + "\n\n...  [Code truncated for brevity]"
        
        # ✅ AGGRESSIVE UNICODE STRIPPING - Remove all non-ASCII characters
        import re
        # Replace common problematic characters first
        raw_code = raw_code.replace('✓', '[OK]')
        raw_code = raw_code.replace('✗', '[X]')
        raw_code = raw_code.replace('→', '->')
        raw_code = raw_code.replace('←', '<-')
        raw_code = raw_code.replace('…', '...')
        raw_code = raw_code.replace(''', "'")
        raw_code = raw_code.replace(''', "'")
        raw_code = raw_code.replace('"', '"')
        raw_code = raw_code.replace('"', '"')
        raw_code = raw_code.replace('—', '--')
        raw_code = raw_code.replace('–', '-')
        
        # Remove any remaining non-ASCII characters
        raw_code = re.sub(r'[^\x00-\x7F]+', ' ', raw_code)
        
        # Escape for LaTeX
        safe_code = escape_latex(raw_code)
        
        # Replace newlines with LaTeX line breaks
        formatted_code = safe_code.replace('\n', r'\\').replace('  ', r'\hspace{1em}')
        
        doc.append(NoEscape(r'''
        \begin{tcolorbox}[
            colback=STBgGray, 
            colframe=''' + color_name + r''', 
            boxrule=1pt, 
            arc=1mm, 
            left=5pt, 
            right=5pt, 
            top=5pt, 
            bottom=5pt,
            breakable
        ]
            \ttfamily\footnotesize\color{STText}
        '''))
        
        doc.append(NoEscape(formatted_code))
        
        doc.append(NoEscape(r'\end{tcolorbox}'))
        
        doc.append(NoEscape(r'\vspace{0.3cm}'))
    
    # -------------------------------------------------------------------------
    # SECURITY IMPACT SECTION
    # -------------------------------------------------------------------------
    
    doc.append(NoEscape(r'\textbf{\large Security Impact}\\[0.2cm]'))
    
    # Generate impact statement based on severity
    if vuln['severity'] == 'critical':
        impact_text = r'''
        This critical vulnerability could allow an attacker to:
        \begin{itemize}[leftmargin=*, topsep=2pt, itemsep=2pt]
            \item Gain unauthorized access to sensitive systems or data
            \item Execute arbitrary code on the server
            \item Compromise the entire application infrastructure
            \item Exfiltrate confidential information
        \end{itemize}
        \textbf{Business Consequences:} Data breach, regulatory fines, reputational damage, legal liability
        '''
    elif vuln['severity'] == 'high':
        impact_text = r'''
        This high-severity issue could enable an attacker to:
        \begin{itemize}[leftmargin=*, topsep=2pt, itemsep=2pt]
            \item Bypass authentication or authorization controls
            \item Access or modify sensitive data
            \item Inject malicious payloads
            \item Escalate privileges
        \end{itemize}
        \textbf{Business Consequences:} Data exposure, compliance violations, service disruption
        '''
    elif vuln['severity'] == 'medium':
        impact_text = r'''
        This moderate security weakness could be exploited to:
        \begin{itemize}[leftmargin=*, topsep=2pt, itemsep=2pt]
            \item Gather information about the system
            \item Perform limited unauthorized actions
            \item Facilitate further exploitation attempts
        \end{itemize}
        \textbf{Business Consequences:} Increased attack surface, potential stepping stone for advanced attacks
        '''
    else: 
        impact_text = r'''
        This low-severity issue has minimal direct security impact but represents a security best 
        practice violation that should be addressed to maintain code quality and defense-in-depth.
        '''
    
    doc.append(NoEscape(impact_text))
    
    doc.append(NoEscape(r'\vspace{0.3cm}'))
    
    # -------------------------------------------------------------------------
    # REMEDIATION GUIDANCE SECTION
    # -------------------------------------------------------------------------
    
    doc.append(NoEscape(r'\textbf{\large Remediation Guidance}\\[0.2cm]'))
    doc.append(NoEscape(vuln['remediation']))
    
    doc.append(NoEscape(r'\vspace{0.2cm}'))
    
    # -------------------------------------------------------------------------
    # AUTOMATED FIX SUGGESTION (IF AVAILABLE)
    # -------------------------------------------------------------------------
    
    if vuln.get('fix_suggestion'):
        doc.append(NoEscape(r'''
        \begin{tcolorbox}[
            colback=success! 5, 
            colframe=success, 
            title=\textbf{Suggested Fix (Copy \& Apply)}, 
            boxrule=1.5pt,
            coltitle=white,
            fonttitle=\bfseries,
            breakable
        ]
            \ttfamily\footnotesize
        '''))
        
        raw_fix = vuln['fix_suggestion'].strip()
        
        # Truncate if too long
        if len(raw_fix) > 800:
            raw_fix = raw_fix[:800] + "\n...  [Fix truncated]"
        
        # ✅ AGGRESSIVE UNICODE STRIPPING
        import re
        raw_fix = raw_fix.replace('✓', '[OK]')
        raw_fix = raw_fix. replace('✗', '[X]')
        raw_fix = raw_fix.replace('→', '->')
        raw_fix = raw_fix.replace('…', '...')
        raw_fix = raw_fix.replace(''', "'")
        raw_fix = raw_fix.replace(''', "'")
        raw_fix = raw_fix.replace('"', '"')
        raw_fix = raw_fix.replace('"', '"')
        
        # Remove any remaining non-ASCII
        raw_fix = re.sub(r'[^\x00-\x7F]+', ' ', raw_fix)
        
        safe_fix = escape_latex(raw_fix).replace('\n', r'\\').replace('  ', r'\hspace{1em}')
        doc.append(NoEscape(safe_fix))
        
        doc.append(NoEscape(r'\end{tcolorbox}'))
    
    # -------------------------------------------------------------------------
    # REFERENCES & FURTHER READING
    # -------------------------------------------------------------------------
    
    doc.append(NoEscape(r'\vspace{0.3cm}'))
    doc.append(NoEscape(r'\textbf{References \& Further Reading: }\\[0.1cm]'))
    doc.append(NoEscape(r'\small'))
    
    # Generate reference links
    cwe_id = vuln['cwe'].replace('CWE-', '').split()[0] if 'CWE-' in vuln['cwe'] else None
    
    if cwe_id and cwe_id.isdigit():
        doc.append(NoEscape(rf'\url{{https://cwe.mitre.org/data/definitions/{cwe_id}.html}} \\'))
    
    if 'A0' in vuln['owasp']:
        owasp_code = vuln['owasp'].split(':')[0].strip()
        doc.append(NoEscape(rf'\url{{https://owasp.org/Top10/{owasp_code}/}} \\'))
    
    doc.append(NoEscape(r'\normalsize'))
    
    doc.append(NoEscape(r'\end{findingbox}'))
    doc.append(NoEscape(r'\vspace{0.5cm}'))


def _render_low_severity_summary(doc, low_vulns):
    """
    Render low severity vulnerabilities as a summary table instead of full details
    """
    
    doc.append(NoEscape(r'''
    \noindent
    The following table summarizes low-severity findings.  Full details are available in the 
    SecureThread OPS dashboard. 
    \vspace{0.3cm}
    
    \begin{center}
    \rowcolors{2}{STBgGray}{white}
    \begin{longtable}{|p{0.06\textwidth}|p{0.35\textwidth}|p{0.13\textwidth}|p{0.35\textwidth}|}
        \hline
        \rowcolor{STBlue}
        \textbf{\textcolor{white}{ID}} & 
        \textbf{\textcolor{white}{Title}} & 
        \textbf{\textcolor{white}{Category}} & 
        \textbf{\textcolor{white}{Location}} \\
        \hline
        \endhead
    '''))
    
    for vuln in low_vulns[:25]:  # Show first 25
        title_display = vuln['title'][:45] + '...' if len(vuln['title']) > 45 else vuln['title']
        location_display = vuln['location'][:40] + '...' if len(vuln['location']) > 40 else vuln['location']
        
        doc.append(NoEscape(rf'''
        \#{vuln['index']} & 
        {title_display} & 
        {vuln['category'][:20]} & 
        \texttt{{\footnotesize {location_display}}} \\
        '''))
    
    doc.append(NoEscape(r'''
        \hline
    \end{longtable}
    \end{center}
    '''))
    
    if len(low_vulns) > 25:
        remaining = len(low_vulns) - 25
        doc.append(NoEscape(rf'''
        \noindent
        \textit{{Note: {remaining} additional low-severity findings are available in the complete scan results.}}
        '''))


def _render_informational_summary(doc, info_vulns):
    """
    Render informational findings as a simple bulleted list
    """
    
    doc.append(NoEscape(r'\begin{itemize}[leftmargin=*, topsep=3pt, itemsep=5pt]'))
    
    for vuln in info_vulns[:15]:  # Show first 15
        doc.append(NoEscape(rf'''
        \item \textbf{{{vuln['title']}}} \\
        \textit{{{vuln['category']}}} - \texttt{{\footnotesize {vuln['location'][:60]}}}
        '''))
    
    doc.append(NoEscape(r'\end{itemize}'))
    
    if len(info_vulns) > 15:
        remaining = len(info_vulns) - 15
        doc.append(NoEscape(rf'''
        \vspace{{0.2cm}}
        \noindent
        \textit{{... and {remaining} more informational findings}}
        '''))
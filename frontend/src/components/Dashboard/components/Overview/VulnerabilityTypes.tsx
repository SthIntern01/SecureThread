import React, { useState, useEffect } from 'react';
import { Badge } from "@/components/ui/badge";
import { Bug, Shield, BarChart3 } from "lucide-react";
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell } from 'recharts';
import { EnhancedDashboardData } from '../../types/dashboard. types';

interface VulnerabilityTypesProps {
  data: EnhancedDashboardData;
}

const VulnerabilityTypes: React.FC<VulnerabilityTypesProps> = ({ data }) => {
  const [isVisible, setIsVisible] = useState(false);
  const [showChart, setShowChart] = useState(true);

  const trends = data.advancedMetrics?.vulnerabilityTrends?. monthly_trends || [];

  useEffect(() => {
    setTimeout(() => setIsVisible(true), 400);
  }, []);

  const getScanTypeBadge = (scanType: 'standard' | 'custom') => {
    return (
      <Badge className={`text-xs ${
        scanType === 'custom' 
          ? 'bg-[#E8F0FF] text-[#2D5FFF] border-[#2D5FFF]/30 dark:bg-purple-500/20 dark:text-purple-300 dark:border-purple-500/30' 
          : 'bg-[#D6E6FF] text-[#004E89] border-[#004E89]/30 dark:bg-blue-500/20 dark:text-blue-300 dark:border-blue-500/30'
      }`}>
        {scanType === 'custom' ? 'Custom' : 'Standard'}
      </Badge>
    );
  };

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case 'critical': return '#EF4444';
      case 'high': return '#F97316';
      case 'medium': return '#EAB308';
      case 'low': return '#22C55E';
      default:  return '#9CA3AF';
    }
  };

  // Prepare chart data
  const chartData = data.vulnerabilityTypes.slice(0, 6).map(vuln => ({
    name: vuln.type. length > 20 ? vuln.type.substring(0, 17) + '...' : vuln.type,
    fullName: vuln.type,
    count: vuln.count,
    severity: vuln.severity,
    color: getSeverityColor(vuln.severity),
    scan_type: vuln.scan_type
  }));

  const CustomTooltip = ({ active, payload }: any) => {
    if (active && payload && payload.length) {
      return (
        <div className="bg-white dark:bg-gray-900 border-2 border-gray-200 dark:border-white/20 rounded-lg p-3 shadow-xl">
          <p className="font-semibold text-gray-900 dark:text-white mb-1">{payload[0].payload. fullName}</p>
          <p className="text-sm" style={{ color: payload[0].payload.color }}>
            Count: <span className="font-bold">{payload[0].value}</span>
          </p>
          <p className="text-xs text-gray-500 dark:text-white/60 mt-1 capitalize">
            Severity: {payload[0].payload.severity}
          </p>
          <p className="text-xs text-gray-500 dark:text-white/60">
            Type: {payload[0].payload. scan_type}
          </p>
        </div>
      );
    }
    return null;
  };

  return (
    <div className={`transition-all duration-500 ${
      isVisible ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4'
    }`}>
      <div className="flex items-center justify-between mb-3">
        <h3 className="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
          <Bug className="w-5 h-5 mr-2 text-[#2D5FFF] dark:text-accent" />
          Top Vulnerability Types
        </h3>
        {data.vulnerabilityTypes.length > 0 && (
          <button
            onClick={() => setShowChart(!showChart)}
            className="px-3 py-1 text-xs bg-gray-100 dark:bg-white/10 hover:bg-gray-200 dark:hover:bg-white/20 rounded-full transition-colors flex items-center gap-1"
          >
            <BarChart3 className="w-3 h-3" />
            {showChart ? 'List' : 'Chart'}
          </button>
        )}
      </div>

      {data.vulnerabilityTypes.length > 0 ?  (
        <>
          {/* Chart View */}
          {showChart && (
            <div className="mb-6">
              <ResponsiveContainer width="100%" height={250}>
                <BarChart 
                  data={chartData} 
                  layout="vertical"
                  margin={{ top: 5, right: 30, left:  100, bottom: 5 }}
                >
                  <CartesianGrid strokeDasharray="3 3" stroke="#374151" opacity={0.2} />
                  <XAxis 
                    type="number"
                    stroke="#9CA3AF"
                    style={{ fontSize: '11px' }}
                  />
                  <YAxis 
                    type="category"
                    dataKey="name"
                    stroke="#9CA3AF"
                    style={{ fontSize: '11px' }}
                    width={95}
                  />
                  <Tooltip content={<CustomTooltip />} />
                  <Bar 
                    dataKey="count" 
                    radius={[0, 8, 8, 0]}
                    animationDuration={1500}
                  >
                    {chartData. map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={entry.color} />
                    ))}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </div>
          )}

          {/* List View */}
          <div className="grid grid-cols-1 gap-2">
            {data.vulnerabilityTypes.slice(0, 6).map((vuln, index) => (
              <div key={index} className="flex items-center justify-between py-2 px-3 rounded-lg bg-white border border-gray-200 dark:bg-black/10 dark:border-white/10 hover:bg-gray-50 dark:hover:bg-white/5 transition-colors">
                <div className="flex items-center space-x-3 flex-1 min-w-0">
                  <div className={`w-3 h-3 rounded-full flex-shrink-0`} style={{ backgroundColor: getSeverityColor(vuln.severity) }} />
                  <span className="text-gray-700 dark:text-white/80 text-sm truncate">{vuln.type}</span>
                  {getScanTypeBadge(vuln.scan_type || 'standard')}
                </div>
                <Badge
                  className={`text-xs ml-2 ${
                    vuln.severity === "critical"
                      ? "bg-red-50 text-red-700 border-red-300 dark:bg-red-500/20 dark:text-red-300 dark:border-red-500/30"
                      : vuln.severity === "high"
                      ? "bg-orange-50 text-orange-700 border-orange-300 dark:bg-orange-500/20 dark:text-orange-300 dark:border-orange-500/30"
                      : vuln. severity === "medium"
                      ? "bg-yellow-50 text-yellow-700 border-yellow-300 dark:bg-yellow-500/20 dark: text-yellow-300 dark: border-yellow-500/30"
                      : "bg-gray-100 text-gray-700 border-gray-300 dark:bg-gray-500/20 dark:text-gray-300 dark:border-gray-500/30"
                  }`}
                >
                  {vuln.count}
                </Badge>
              </div>
            ))}
          </div>

          {data.vulnerabilityTypes.length > 6 && (
            <div className="mt-3 text-center">
              <p className="text-sm text-gray-500 dark:text-white/60">
                +{data.vulnerabilityTypes.length - 6} more types
              </p>
            </div>
          )}
        </>
      ) : (
        <div className="text-center py-8 text-gray-500 dark: text-white/60">
          <Shield className="w-12 h-12 mx-auto mb-3 text-green-500/60 dark:text-green-400/60" />
          <p>No vulnerabilities detected</p>
          <p className="text-sm text-gray-400 dark:text-white/40 mt-1">
            {data.totalProjects === 0 
              ? 'Connect repositories to start monitoring'
              : 'Your code is secure!'
            }
          </p>
        </div>
      )}
    </div>
  );
};

export default VulnerabilityTypes;
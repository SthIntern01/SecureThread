# backend/app/models/vulnerability.py

from sqlalchemy import Column, Integer, String, Text, Boolean, DateTime, JSON, ForeignKey, Float, ARRAY
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from app.core.database import Base
from datetime import datetime


class Scan(Base):
    """Model for vulnerability scans"""
    
    __tablename__ = "scans"
    
    id = Column(Integer, primary_key=True, index=True)
    repository_id = Column(Integer, ForeignKey("repositories.id", ondelete="CASCADE"), nullable=False, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    status = Column(String(50), nullable=False, default="pending")  # pending, running, completed, failed
    scan_type = Column(String(50))  # quick, full, custom
    started_at = Column(DateTime(timezone=True), server_default=func.now())
    completed_at = Column(DateTime(timezone=True))
    total_files_scanned = Column(Integer, default=0)
    total_vulnerabilities = Column(Integer, default=0)
    critical_count = Column(Integer, default=0)
    high_count = Column(Integer, default=0)
    medium_count = Column(Integer, default=0)
    low_count = Column(Integer, default=0)
    security_score = Column(Float)
    code_coverage = Column(Float)
    error_message = Column(Text)
    scan_metadata = Column(JSON)
    scan_duration = Column(String)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())
    
    # Relationships
    repository = relationship("Repository", back_populates="scans")
    user = relationship("User", backref="scans")
    vulnerabilities = relationship("Vulnerability", back_populates="scan", cascade="all, delete-orphan")
    
    def __repr__(self):
        return f"<Scan(id={self.id}, repository_id={self.repository_id}, status={self.status})>"


class Vulnerability(Base):
    """Model for detected vulnerabilities"""
    
    __tablename__ = "vulnerabilities"
    
    id = Column(Integer, primary_key=True, index=True)
    scan_id = Column(Integer, ForeignKey("scans.id", ondelete="CASCADE"), nullable=False, index=True)
    repository_id = Column(Integer, ForeignKey("repositories.id", ondelete="CASCADE"), nullable=False, index=True)
    title = Column(String(255), nullable=False)
    description = Column(Text, nullable=False)
    severity = Column(String(20), nullable=False, index=True)  # critical, high, medium, low
    category = Column(String(100), nullable=False)
    cwe_id = Column(String(20))
    owasp_category = Column(String(100))
    file_path = Column(Text, nullable=False)
    line_number = Column(Integer)
    line_end_number = Column(Integer)
    code_snippet = Column(Text)
    recommendation = Column(Text, nullable=False)
    fix_suggestion = Column(Text)
    risk_score = Column(Float)
    exploitability = Column(String(20))
    impact = Column(String(20))
    status = Column(String(20), default="open")  # open, reviewing, fixed, false_positive, accepted_risk
    detected_at = Column(DateTime(timezone=True), server_default=func.now())
    resolved_at = Column(DateTime(timezone=True))
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())
    
    # Relationships
    scan = relationship("Scan", back_populates="vulnerabilities")
    repository = relationship("Repository", backref="vulnerabilities")
    
    def __repr__(self):
        return f"<Vulnerability(id={self.id}, title={self.title}, severity={self.severity})>"


class VulnerabilityFix(Base):
    """Model for storing vulnerability fixes before PR creation"""
    
    __tablename__ = "vulnerability_fixes"
    
    id = Column(Integer, primary_key=True, index=True)
    # FIXED: Added ForeignKey to vulnerability_id
    vulnerability_id = Column(Integer, ForeignKey("vulnerabilities.id", ondelete="CASCADE"), nullable=False, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    file_path = Column(Text, nullable=False)
    original_code = Column(Text, nullable=False)
    fixed_code = Column(Text, nullable=False)
    fix_type = Column(String(20), nullable=False)  # 'manual' or 'ai_suggested'
    status = Column(String(20), nullable=False, default='draft')  # 'draft', 'pending_pr', 'pr_created'
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())
    
    # Relationships
    user = relationship("User", backref="vulnerability_fixes")
    vulnerability = relationship("Vulnerability", backref="fixes")
    
    def __repr__(self):
        # FIXED: Removed space in self.id
        return f"<VulnerabilityFix(id={self.id}, file={self.file_path}, status={self.status})>"


class PullRequest(Base):
    """Model for tracking created pull requests"""
    
    __tablename__ = "pull_requests"
    
    id = Column(Integer, primary_key=True, index=True)
    # FIXED: Added ForeignKey to repository_id
    repository_id = Column(Integer, ForeignKey("repositories.id", ondelete="CASCADE"), nullable=False, index=True)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"), nullable=False, index=True)
    pr_number = Column(Integer)
    pr_url = Column(Text)
    branch_name = Column(String(255), nullable=False)
    title = Column(Text, nullable=False)
    description = Column(Text)
    fixes_included = Column(ARRAY(Integer), nullable=False, default=[])
    status = Column(String(20), nullable=False, default='open')  # 'open', 'merged', 'closed', 'failed'
    github_response = Column(JSON)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())
    
    # Relationships
    user = relationship("User", backref="pull_requests")
    repository = relationship("Repository", backref="pull_requests")
    
    def __repr__(self):
        return f"<PullRequest(id={self.id}, pr_number={self.pr_number}, status={self.status})>"